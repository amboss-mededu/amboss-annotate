<!DOCTYPE html>
<html lang='en'>
<head>
  <meta charset='UTF-8'>
  <title>Test page for AMBOSS annotate</title>
</head>
<body>
<h1>Module import</h1>
<p>
  <b class="amboss-ignore">Angiotensin-converting enzyme</b>
  <a href="#" title="Angiotensin-converting enzyme">Angiotensin-converting enzyme</a> Angiotensin-converting
  enzyme covid-19
  <sup id="abc" class="reference"><a href="#">Angiotensin-converting enzyme</a></sup>
</p>

<p>
  <b>Angiotensin-converting enzyme</b>
  <a href="#">Angiotensin-converting enzyme</a> Angiotensin-converting
  enzyme
  <sup><a href="#">Angiotensin-converting enzyme</a></sup>
</p>

<ul class="calc-list calc-list--no-mobile-top-border" data-reactid="235">
  <li class="calc-item" data-reactid="236">
    <a href="/creatinine-clearance-cockcroft-gault-equation" class="index_most-popular_calcItem" data-reactid="237">
      <div class="calc-item__top" data-reactid="238">
        <p class="calc-item__name index_most-popular_calcItem" style="display:inline;padding-right:15px;" data-reactid="239">
          Creatinine Clearance (Cockcroft-Gault Equation)
        </p>
        <div data-reactid="240">
        <span class="calc-item__tag calc-status" data-reactid="241"></span>
          <div class="calc-item__fav-cont" value="43" data-reactid="242"></div>
        </div>
      </div>
      <div class="calc-item__bottom" data-reactid="247">
        <div class="calc-item__desc-row" data-reactid="248">
        <p class="calc-item__desc index_most-popular_calcItem" data-reactid="249">Calculates CrCl according to the Cockcroft-Gault equation.</p>
        <div class="row-credit-container" data-reactid="250">
      </div></div></div></a>
  </li>
  <li class="calc-item" data-reactid="251">
    <a href="/cha2ds2-vasc-score-atrial-fibrillation-stroke-risk" class="index_most-popular_calcItem" data-reactid="252">
    <div class="calc-item__top" data-reactid="253"><p class="calc-item__name index_most-popular_calcItem" style="display:inline;padding-right:15px;" data-reactid="254">CHA₂DS₂-VASc Score for Atrial Fibrillation Stroke Risk</p>
      <div data-reactid="255">
      <span class="calc-item__tag calc-status" data-reactid="256"></span>
      <div class="calc-item__fav-cont" value="801" data-reactid="257"></div>
    </div>
    </div>
    <div class="calc-item__bottom" data-reactid="607">
    <div class="calc-item__desc-row" data-reactid="608">
    <p class="calc-item__desc index_most-popular_calcItem" data-reactid="609">Identifies high-risk patients for in-hospital mortality with suspected infection outside the ICU.</p>
    <div class="row-credit-container" data-reactid="610">
  </div></div></div></a></li>
</ul>
<script type="module">
  import { annotate, initAnnotation } from './src'
  // these phrasio maps should be moved to s3
  import phrasiosDE from './src/phrasios_de.json'
  import phrasiosUS from './src/phrasios_us.json'

  // initialise variables and custom elements
  initAnnotation()

  // overwrite options here
  window.ambossAnnotationOptions.locale = 'us'
  window.ambossAnnotationOptions.campaign = '123890'
  window.ambossAnnotationOptions.token = '0a42c7a3ff83eca9f7323fa129d4dbda'

  // overwrite methods here
  async function getTooltipContentLocal(locale, contentId, campaign = '') {
    if (locale !== 'de' && locale !== 'us') return undefined;
    if (!contentId) return undefined;

    const phrasio = locale === 'us' ? phrasiosUS[contentId] : phrasiosDE[contentId]
    if (!phrasio) {
      console.error('phrasio', phrasio)
      console.error('contentId', contentId)
      return undefined
    }

    function generateHref({ particleEid, articleEid, title, locale, campaign }) {
      const replaceSpacesWithUnderscores = (str) => str.replace(/ /g, '_')
      const urlify = (str) =>
        encodeURIComponent(replaceSpacesWithUnderscores(str)).replace(/[!'()*]/g, (c) => '%' + c.charCodeAt(0).toString(16))
      const utmString = `?utm_campaign=${campaign}&utm_term=${urlify(title)}`
      const anchorString = particleEid ? `#${particleEid}` : ''
      // https://next.amboss.com/us/article/4N03Yg?utm_campaign=aaas&utm_term=FAST#Zefeb92d093a9fbf8b7c983722bdbb10d
      return `https://next.amboss.com/${locale}/article/${articleEid}${utmString}${anchorString}`
    }

    function normalisePhrasio(phrasioRAW, locale, campaign) {
      const destinations = Array.isArray(phrasioRAW.destinations) ? phrasioRAW.destinations : []

      return {
        title: phrasioRAW.title || '',
        subtitle: phrasioRAW.etymology || '',
        body: phrasioRAW.description || '',
        media: [],
        destinations: destinations.map((d) => ({
          label: d.label,
          href: generateHref({
            particleEid: d.anchor || '',
            articleEid: d.lc_xid || '',
            title: phrasioRAW.title || '',
            locale,
            campaign,
          }),
        })),
      }
    }

    return normalisePhrasio(phrasio, locale, campaign)
  }

  async function getTooltipContentApi(token = '', locale, contentId, campaign = '') {
    if (locale !== 'de' && locale !== 'us') return undefined;
    if (!contentId) return undefined;

    function generateHref({ particleEid, articleEid, title, locale, campaign }) {
      const replaceSpacesWithUnderscores = (str) => str.replace(/ /g, '_')
      const urlify = (str) =>
        encodeURIComponent(replaceSpacesWithUnderscores(str)).replace(/[!'()*]/g, (c) => '%' + c.charCodeAt(0).toString(16))
      const utmString = `?utm_campaign=${campaign}&utm_term=${urlify(title)}`
      const anchorString = particleEid ? `#${particleEid}` : ''
      // https://next.amboss.com/us/article/4N03Yg?utm_campaign=aaas&utm_term=FAST#Zefeb92d093a9fbf8b7c983722bdbb10d
      return `https://next.amboss.com/${locale}/article/${articleEid}${utmString}${anchorString}`
    }

    function normalisePhrasio(phrasioRAW, locale, campaign) {
      const destinations = Array.isArray(phrasioRAW.destinations) ? phrasioRAW.destinations : []
      const media = Array.isArray(phrasioRAW.media) ? phrasioRAW.media : []
      return {
        title: phrasioRAW.title || '',
        subtitle: phrasioRAW.translation || '',
        body: phrasioRAW.abstract || '',
        media: media.map((m) => ({
          eid: m.eid,
          copyright: m.copyright.html,
          title: m.title,
          href: m.canonicalUrl,
        })),
        destinations: destinations.map((d) => ({
          label: d.label,
          href: generateHref({
            particleEid: d.particleEid || '',
            articleEid: d.articleEid || '',
            title: phrasioRAW.title || '',
            locale,
            campaign,
          }),
        })),
      }
    }

    const bodyWithMedia = `{"query":"{phraseGroup(eid: \\"${contentId}\\") {title\\nabstract\\ntranslation\\ndestinations {\\nlabel\\narticleEid\\nparticleEid}\\nmedia {\\ntitle\\neid\\ncanonicalUrl\\ncopyright {\\nhtml}}}}"}`

    const fetchPhrasioWithMedia = (body) => fetch(`https://www.labamboss.com/${locale}/api/graphql`, {
      "method": "POST",
      "headers": {
        "Content-Type": "application/json",
        "authorization": `Bearer ${token}`,
      },
      "body": body
    })

    return fetchPhrasioWithMedia(bodyWithMedia).then(async (res) => {
      const { data, errors } = await res.json()
      if (!Array.isArray(errors) && data && data.phraseGroup) {
        return normalisePhrasio(data.phraseGroup, locale, campaign)
      } else if (data === null) {
        console.error(errors)
        return undefined
      }
    })
      .catch(console.error);
  }

  window.ambossAnnotationAdaptor.getTooltipContent = async (contentId) => {
    const {locale, token, campaign, offline} = window.ambossAnnotationOptions;
    console.info('adaptor getTooltipContent', {locale, token, campaign, contentId})

    return offline ? getTooltipContentLocal(locale, contentId, campaign) : getTooltipContentApi(token, locale, contentId, campaign)
  }

  window.ambossAnnotationAdaptor.track = async (trackingProperties) => console.info('adaptor track', trackingProperties);

  // call annotation
  annotate()
</script>
</body>
</html>
